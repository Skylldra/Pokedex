<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" href="/favicon.jpg" type="image/jpeg">
    <link rel="shortcut icon" href="/favicon.jpg" type="image/jpeg">
    <title>Dein Pokédex</title>
    <style>
        /* Dark Mode Styles */
        body {
            font-family: Arial, sans-serif;
            text-align: center;
            background-color: #121212; /* Dunkler Hintergrund */
            color: #E0E0E0; /* Helle Schrift */
            margin: 0;
            padding: 20px;
        }
        @font-face {
            font-family: 'Pokemon';
            src: url('https://db.onlinewebfonts.com/t/f4d1593471d222ddebd973210265762a.woff2') format('woff2'),
                 url('https://db.onlinewebfonts.com/t/f4d1593471d222ddebd973210265762a.woff') format('woff');
            font-weight: normal;
            font-style: normal;
        }

        /* Hintergrund-Themes */
        body.theme-dark {
            background-color: #121212; /* Standard-Dunkel */
        }

        body.theme-wall1 {
            background-color: #1e3a23;
            background-image: url('/Wallpaper/Wallpaper1.jpg');
            background-size: cover;
            background-attachment: fixed;
        }

        body.theme-wall2 {
            background-color: #193549;
            background-image: url('/Wallpaper/Wallpaper2.jpg');
            background-size: cover;
            background-attachment: fixed;
        }

        body.theme-wall3 {
            background-color: #4a1e1e;
            background-image: url('/Wallpaper/Wallpaper3.jpg');
            background-size: cover;
            background-attachment: fixed;
        }

        body.theme-wall4 {
            background-color: #5a4e1e;
            background-image: url('/Wallpaper/Wallpaper4.jpg');
            background-size: cover;
            background-attachment: fixed;
        }

        body.theme-wall5 {
            background-color: #3e1e5a;
            background-image: url('/Wallpaper/Wallpaper5.jpg');
            background-size: cover;
            background-attachment: fixed;
        }

        body.theme-wall6 {
            background-color: #2c2c4a;
            background-image: url('/Wallpaper/Wallpaper6.jpg');
            background-size: cover;
            background-attachment: fixed;
        }

        body.theme-wall7 {
            background-color: #6b2d2d;
            background-image: url('/Wallpaper/Wallpaper7.jpg');
            background-size: cover;
            background-attachment: fixed;
        }

        body.theme-wall8 {
            background-color: #83b8d6;
            background-image: url('/Wallpaper/Wallpaper8.jpg');
            background-size: cover;
            background-attachment: fixed;
        }

        body.theme-wall9 {
            background-color: #83b8d6;
            background-image: url('/Wallpaper/Wallpaper9.jpg');
            background-size: cover;
            background-attachment: fixed;
        }

        body.theme-wall10 {
            background-color: #83b8d6;
            background-image: url('/Wallpaper/Wallpaper10.jpg');
            background-size: cover;
            background-attachment: fixed;
        }

        body.theme-wall11 {
            background-color: #83b8d6;
            background-image: url('/Wallpaper/Wallpaper11.jpg');
            background-size: cover;
            background-attachment: fixed;
        }

        body.theme-wall12 {
            background-color: #83b8d6;
            background-image: url('/Wallpaper/Wallpaper12.jpg');
            background-size: cover;
            background-attachment: fixed;
        }

        body.theme-wall13 {
            background-color: #83b8d6;
            background-image: url('/Wallpaper/Wallpaper13.jpg');
            background-size: cover;
            background-attachment: fixed;
        }

        body.theme-wall14 {
            background-color: #83b8d6;
            background-image: url('/Wallpaper/Wallpaper14.jpg');
            background-size: cover;
            background-attachment: fixed;
        }

        body.theme-wall15 {
            background-color: #83b8d6;
            background-image: url('/Wallpaper/Wallpaper15.jpg');
            background-size: cover;
            background-attachment: fixed;
        }

        body.theme-custom {
            background-size: cover;
            background-attachment: fixed;
            background-position: center;
        }

        /* Theme Selector Styles */
        .theme-selector {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 100;
        }

        .theme-button {
            background-color: #3B5BA7;
            color: #FFCB05;
            border: 2px solid #FFCB05;
            border-radius: 5px;
            padding: 8px 15px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .theme-button:hover {
            background-color: #FFCB05;
            color: #3B5BA7;
        }

        .theme-dropdown {
            display: none;
            position: absolute;
            right: 0;
            top: 40px;
            background-color: rgba(30, 30, 30, 0.9);
            border: 2px solid #FFCB05;
            border-radius: 5px;
            width: 250px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.5);
            z-index: 101;
            max-height: 80vh;
            overflow-y: auto;
        }

        .theme-dropdown.active {
            display: block;
        }

        .theme-option {
            padding: 10px 15px;
            color: #E0E0E0;
            cursor: pointer;
            border-bottom: 1px solid rgba(51, 51, 51, 0.7);
            transition: background-color 0.2s;
            display: flex;
            align-items: center;
        }

        .theme-option:hover {
            background-color: rgba(51, 51, 51, 0.7);
        }

        .theme-option:last-child {
            border-bottom: none;
        }

        .theme-preview {
            width: 40px;
            height: 40px;
            border-radius: 4px;
            margin-right: 10px;
            background-size: cover;
            background-position: center;
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .theme-option span {
            flex: 1;
        }

        h1 {
            font-family: 'Pokemon', sans-serif;
            color: #FFCB05; /* Pokémon Gelb */
            text-shadow: 3px 3px 0 #3B5BA7, /* Pokémon Blau */
                         -1px -1px 0 #3B5BA7,  
                         1px -1px 0 #3B5BA7,
                         -1px 1px 0 #3B5BA7,
                         1px 1px 0 #3B5BA7;
            font-size: 2.5rem;
            letter-spacing: 1px;
            margin-bottom: 30px;
        }

        #pokedex-container {
            display: flex;
            flex-direction: row;
            justify-content: space-between;
            max-width: 1400px;
            margin: auto;
            gap: 20px;
        }

        .pokedex-section {
            padding: 20px;
            background: rgba(30, 30, 30, 0.8);
            border-radius: 10px;
            box-shadow: 0px 0px 10px rgba(0, 0, 0, 0.3);
            flex: 1;
            max-width: 48%;
        }

        #caught-pokemon {
            border: 3px solid #4CAF50; /* Grüne Umrandung für gefangene Pokémon */
        }

        #seen-pokemon {
            border: 3px solid #FF5252; /* Rote Umrandung für gesehene Pokémon */
        }

        .section-title {
            margin-top: 0;
            padding-bottom: 10px;
            border-bottom: 1px solid rgba(51, 51, 51, 0.7);
        }

        #caught-pokemon .section-title {
            color: #4CAF50; /* Grüne Überschrift für gefangene Pokémon */
        }

        #seen-pokemon .section-title {
            color: #FF5252; /* Rote Überschrift für gesehene Pokémon */
        }

        .pokemon-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 10px;
            justify-content: start;
        }

        .pokemon-card {
            background-color: rgba(20, 20, 20, 0.7);
            border-radius: 8px;
            padding: 10px;
            display: flex;
            flex-direction: column;
            align-items: center;
            transition: transform 0.2s, background-color 0.2s;
            cursor: pointer;
        }

        .pokemon-card:hover {
            transform: translateY(-5px);
            background-color: rgba(40, 40, 40, 0.8);
        }

        .pokemon-image {
            width: 60px;
            height: 60px;
            object-fit: contain;
            margin-bottom: 8px;
        }

        .pokemon-name {
            font-size: 0.9rem;
            font-weight: bold;
            margin: 5px 0;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            width: 100%;
            text-align: center;
        }

        .pokemon-id {
            font-size: 0.8rem;
            color: #999;
        }

        /* Shiny Indicator */
        .shiny-indicator {
            color: #FFD700;
            font-size: 1.2rem;
            margin-left: 5px;
        }

        /* Status Indicator */
        .status-caught {
            color: #4CAF50;
            font-size: 0.8rem;
            margin-top: 5px;
        }

        .status-seen {
            color: #FF5252;
            font-size: 0.8rem;
            margin-top: 5px;
        }

        /* Modal-Style für die vergrößerte Ansicht */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.9);
            overflow: auto;
        }

        .modal-content {
            margin: 5% auto;
            width: auto;
            max-width: 90%;
            min-width: 300px;
            background-color: #1E1E1E;
            border-radius: 10px;
            box-shadow: 0 0 20px rgba(255, 255, 255, 0.2);
            padding: 20px;
            position: relative;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .modal-image {
            width: 150px; /* Größeres Bild im Modal */
            height: 150px;
            object-fit: contain;
            margin-bottom: 20px;
        }

        .modal-info {
            width: 100%;
            text-align: center;
            margin-bottom: 20px;
        }

        .modal-description {
            width: 100%;
            background-color: #2A2A2A;
            padding: 15px;
            border-radius: 8px;
            margin-top: 10px;
            max-height: 200px;
            overflow-y: auto;
            text-align: left; /* Linksbündiger Text */
            line-height: 1.6; /* Erhöhter Zeilenabstand */
        }

        .close-button {
            position: absolute;
            top: 10px;
            right: 15px;
            color: #E0E0E0;
            font-size: 24px;
            font-weight: bold;
            cursor: pointer;
        }

        .close-button:hover {
            color: #FF5252;
        }

        /* Empty state message */
        .empty-message {
            padding: 20px;
            font-style: italic;
            color: #999;
        }

        /* Shiny Counter Styles */
        .shiny-counter {
            position: fixed;
            top: 20px;
            left: 20px;
            z-index: 100;
            background: rgba(30, 30, 30, 0.8);
            border-radius: 10px;
            padding: 10px 15px;
            border: 3px solid #FFD700; /* Goldene Umrandung */
            box-shadow: 0px 0px 10px rgba(255, 215, 0, 0.5);
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            min-width: 120px;
        }

        .shiny-counter-text {
            color: #FFD700; /* Goldene Farbe für Text */
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.7);
        }

        .shiny-counter-value {
            margin-left: 5px;
            font-size: 1.2rem;
            color: white;
        }

        /* Kleiner Shiny-Funkeln-Effekt */
        .shiny-sparkle {
            display: inline-block;
            animation: sparkle 2s infinite;
            transform-origin: center;
        }

        @keyframes sparkle {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.2); opacity: 0.8; }
        }

        /* Responsive Design für mobile Geräte */
        @media (max-width: 1200px) {
            .pokemon-grid {
                grid-template-columns: repeat(4, 1fr);
            }
        }

        @media (max-width: 992px) {
            .pokemon-grid {
                grid-template-columns: repeat(3, 1fr);
            }
        }

        @media (max-width: 768px) {
            #pokedex-container {
                flex-direction: column;
            }

            .pokedex-section {
                max-width: 100%;
                margin-bottom: 20px;
            }

            .pokemon-grid {
                grid-template-columns: repeat(3, 1fr);
            }

            .shiny-counter {
                top: 80px; /* Unter dem Titel auf mobilen Geräten */
            }
        }

        @media (max-width: 480px) {
            .pokemon-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
    </style>
</head>
<body>
    <h1>Pokédex von <span id="username"></span></h1>

    <!-- Shiny Counter -->
    <div class="shiny-counter">
        <span class="shiny-counter-text">
            <span class="shiny-sparkle">✨</span> Shinys <span class="shiny-sparkle">✨</span>: 
        </span>
        <span id="shiny-count" class="shiny-counter-value">0</span>
    </div>

    <div class="theme-selector">
        <button id="theme-btn" class="theme-button">Hintergrund ändern</button>
        <div id="theme-dropdown" class="theme-dropdown">
            <div class="theme-option" data-theme="dark">
                <div class="theme-preview" style="background-color: #121212;"></div>
                <span>Standard (Dunkel)</span>
            </div>
            <div class="theme-option" data-theme="wall1">
                <div class="theme-preview" style="background-image: url('/Wallpaper/Wallpaper1.jpg');"></div>
                <span>Poké-Wimmelbild</span>
            </div>
            <div class="theme-option" data-theme="wall2">
                <div class="theme-preview" style="background-image: url('/Wallpaper/Wallpaper2.jpg');"></div>
                <span>Giganten von Raum und Zeit</span>
            </div>
            <div class="theme-option" data-theme="wall3">
                <div class="theme-preview" style="background-image: url('/Wallpaper/Wallpaper3.jpg');"></div>
                <span>Realistische Pokébälle</span>
            </div>
            <div class="theme-option" data-theme="wall4">
                <div class="theme-preview" style="background-image: url('/Wallpaper/Wallpaper4.jpg');"></div>
                <span>Great wave of Kanagawa</span>
            </div>
            <div class="theme-option" data-theme="wall5">
                <div class="theme-preview" style="background-image: url('/Wallpaper/Wallpaper5.jpg');"></div>
                <span>Giratina</span>
            </div>
            <div class="theme-option" data-theme="wall6">
                <div class="theme-preview" style="background-image: url('/Wallpaper/Wallpaper6.jpg');"></div>
                <span>Arceus</span>
            </div>
            <div class="theme-option" data-theme="wall7">
                <div class="theme-preview" style="background-image: url('/Wallpaper/Wallpaper7.jpg');"></div>
                <span>Strandtag mit Plinfa</span>
            </div>
            <div class="theme-option" data-theme="wall8">
                <div class="theme-preview" style="background-image: url('/Wallpaper/Wallpaper8.jpg');"></div>
                <span>Guardevoir's Blumenwiese</span>
            </div>
            <div class="theme-option" data-theme="wall9">
                <div class="theme-preview" style="background-image: url('/Wallpaper/Wallpaper9.jpg');"></div>
                <span>Schattiges Plätzchen</span>
            </div>
            <div class="theme-option" data-theme="wall10">
                <div class="theme-preview" style="background-image: url('/Wallpaper/Wallpaper10.jpg');"></div>
                <span>Ghibli Pokemon</span>
            </div>
            <div class="theme-option" data-theme="wall11">
                <div class="theme-preview" style="background-image: url('/Wallpaper/Wallpaper11.jpg');"></div>
                <span>Saunatag mit Pikachu</span>
            </div>
            <div class="theme-option" data-theme="wall12">
                <div class="theme-preview" style="background-image: url('/Wallpaper/Wallpaper12.jpg');"></div>
                <span>Pokéball Jungeltempel</span>
            </div>
            <div class="theme-option" data-theme="wall13">
                <div class="theme-preview" style="background-image: url('/Wallpaper/Wallpaper13.jpg');"></div>
                <span>Spektral Arceus</span>
            </div>
            <div class="theme-option" data-theme="wall14">
                <div class="theme-preview" style="background-image: url('/Wallpaper/Wallpaper14.jpg');"></div>
                <span>Geister Trainer</span>
            </div>
            <div class="theme-option" data-theme="wall15">
                <div class="theme-preview" style="background-image: url('/Wallpaper/Wallpaper15.jpg');"></div>
                <span>Badespaß mit Enton</span>
            </div>
            <div class="theme-option custom-upload">
                <div class="theme-preview" style="background-color: #3B5BA7; display: flex; justify-content: center; align-items: center;">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#FFCB05" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                        <polyline points="17 8 12 3 7 8"></polyline>
                        <line x1="12" y1="3" x2="12" y2="15"></line>
                    </svg>
                </div>
                <span>Eigenes Bild hochladen</span>
                <input type="file" id="custom-bg-upload" accept="image/*" style="display: none;">
            </div>
        </div>
    </div>

    <div id="pokedex-container">
        <div id="caught-pokemon" class="pokedex-section">
            <h2 class="section-title">Gefangene Pokémon</h2>
            <div id="caught-grid" class="pokemon-grid">
                <div class="empty-message">Lade Daten...</div>
            </div>
        </div>

        <div id="seen-pokemon" class="pokedex-section">
            <h2 class="section-title">Gesehene Pokémon</h2>
            <div id="seen-grid" class="pokemon-grid">
                <div class="empty-message">Lade Daten...</div>
            </div>
        </div>
    </div>

    <!-- Modal für die vergrößerte Ansicht -->
    <div id="pokemonModal" class="modal">
        <div class="modal-content">
            <span class="close-button" onclick="closeModal()">&times;</span>
            <img id="modalImage" class="modal-image" src="" alt="">
            <div class="modal-info" id="modalInfo"></div>
            <div class="modal-description" id="modalDescription">
                Lade Pokédex-Eintrag...
            </div>
        </div>
    </div>

    <script>
        // Twitch-Username aus der URL extrahieren
        const path = window.location.pathname.split("/");
        const username = path[path.length - 1];
        document.getElementById("username").innerText = username;

        // Pokédex-Einträge für die Detailansicht
        let pokedexEntries = {};

        // Lade die Pokédex-Einträge
        fetch('/pokedexeintrag.json')
            .then(response => response.json())
            .then(data => {
                pokedexEntries = data;
            })
            .catch(error => {
                console.error('Fehler beim Laden der Pokédex-Einträge:', error);
            });

        // Hintergrund-Theme-Funktionalität
        document.addEventListener('DOMContentLoaded', function() {
            // Theme-Selector-Elemente
            const themeBtn = document.getElementById('theme-btn');
            const themeDropdown = document.getElementById('theme-dropdown');
            const themeOptions = document.querySelectorAll('.theme-option');
            const customUpload = document.getElementById('custom-bg-upload');
            const customUploadOption = document.querySelector('.theme-option.custom-upload');

            // Klick auf die Upload-Option leitet zum Datei-Input weiter
            customUploadOption.addEventListener('click', function() {
                customUpload.click();
            });

            // Gespeichertes Theme laden
            loadSavedTheme();

            // Toggle Dropdown ein/aus
            themeBtn.addEventListener('click', function() {
                themeDropdown.classList.toggle('active');
            });

            // Schließe Dropdown wenn woanders geklickt wird
            document.addEventListener('click', function(event) {
                if (!event.target.closest('.theme-selector')) {
                    themeDropdown.classList.remove('active');
                }
            });

            // Theme-Option auswählen
            themeOptions.forEach(option => {
                if (!option.classList.contains('custom-upload')) {
                    option.addEventListener('click', function() {
                        const theme = this.getAttribute('data-theme');
                        setTheme(theme);
                        saveTheme(theme);
                        themeDropdown.classList.remove('active');
                    });
                }
            });

            // Eigenes Bild hochladen
            customUpload.addEventListener('change', function(event) {
                const file = event.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        const customBg = e.target.result;
                        document.body.style.backgroundImage = `url(${customBg})`;
                        document.body.className = 'theme-custom';
                        saveCustomBackground(customBg);
                        themeDropdown.classList.remove('active');
                    };
                    reader.readAsDataURL(file);
                }
            });

            // Theme aus dem localStorage laden
            function loadSavedTheme() {
                const savedTheme = localStorage.getItem('pokedexTheme');
                if (savedTheme) {
                    if (savedTheme === 'custom') {
                        const customBg = localStorage.getItem('pokedexCustomBg');
                        if (customBg) {
                            document.body.style.backgroundImage = `url(${customBg})`;
                            document.body.className = 'theme-custom';
                        } else {
                            setTheme('dark'); // Standard-Theme falls custom-Daten fehlen
                        }
                    } else {
                        setTheme(savedTheme);
                    }
                } else {
                    setTheme('dark'); // Standard-Theme wenn noch keins gewählt wurde
                }
            }

            // Theme setzen
            function setTheme(theme) {
                document.body.className = '';
                document.body.style.backgroundImage = '';
                document.body.classList.add('theme-' + theme);
            }

            // Theme im localStorage speichern
            function saveTheme(theme) {
                localStorage.setItem('pokedexTheme', theme);
            }

            // Eigenes Hintergrundbild im localStorage speichern
            function saveCustomBackground(customBg) {
                localStorage.setItem('pokedexTheme', 'custom');
                localStorage.setItem('pokedexCustomBg', customBg);
            }
        });

        // Modal-Funktionen
        const modal = document.getElementById("pokemonModal");

        function openModal(pokemonId, pokemonName, imageUrl) {
            const modalImage = document.getElementById("modalImage");
            const modalInfo = document.getElementById("modalInfo");
            const modalDescription = document.getElementById("modalDescription");
            const modalContent = document.querySelector(".modal-content");

            // Setze Bild und Grundinfos
            modalImage.src = imageUrl;
            modalImage.alt = pokemonName;
            modalInfo.innerHTML = `<h2>#${pokemonId} ${pokemonName}</h2>`;

            // Setze die Beschreibung (wenn verfügbar)
            if (pokedexEntries[pokemonId]) {
                modalDescription.innerHTML = pokedexEntries[pokemonId];

                // Modal-Größe an Textlänge anpassen
                // Kurzer Timeout, damit der Text zuerst gerendert wird
                setTimeout(() => {
                    const textLength = modalDescription.textContent.length;
                    const baseWidth = 300; // Mindestbreite
                    const maxWidth = 600; // Maximale Breite

                    // Berechne Breite basierend auf Textlänge
                    const width = Math.min(baseWidth + textLength * 0.8, maxWidth);
                    modalContent.style.width = width + "px";
                }, 50);
            } else {
                modalDescription.innerHTML = `<p>Kein Pokédex-Eintrag für ${pokemonName} gefunden.</p>`;
                modalContent.style.width = "300px"; // Standardbreite für kurzen Text
            }

            // Zeige Modal
            modal.style.display = "block";
        }

        function closeModal() {
            modal.style.display = "none";
        }

        // Schließe Modal, wenn außerhalb geklickt wird
        window.onclick = function(event) {
            if (event.target == modal) {
                closeModal();
            }
        };

        // Funktion zum Aktualisieren des Shiny-Counters
        function updateShinyCounter(pokemonData) {
            if (!pokemonData || pokemonData.length === 0) return;

            // Zähle nur gefangene Shinys
            const shinyCount = pokemonData.filter(pokemon => 
            (pokemon.gefangen === true || pokemon.gefangen === "true") && 
            (pokemon.shiny === true || pokemon.shiny === "true")
            ).length;

            // Aktualisiere den Counter
            document.getElementById("shiny-count").innerText = shinyCount;
        }

        // Pokédex-Daten abrufen
fetch(`/api/pokedex/${username}`)
    .then(response => response.json())
    .then(data => {
        const caughtGrid = document.getElementById("caught-grid");
        const seenGrid = document.getElementById("seen-grid");

        // Listen leeren
        caughtGrid.innerHTML = "";
        seenGrid.innerHTML = "";

        // Debug: Originaldaten ausgeben
        console.log("Originale Daten:", JSON.stringify(data));

        // Prüfen, ob Daten vorhanden sind
        if (data.length === 0) {
            caughtGrid.innerHTML = "<div class='empty-message'>Keine Pokémon gefunden!</div>";
            seenGrid.innerHTML = "<div class='empty-message'>Keine Pokémon gefunden!</div>";
            return;
        }

        // Normalisiere die Feldnamen, falls sie variieren könnten
        data = data.map(pokemon => {
            // Stelle sicher, dass alle Felder konsistent sind
            return {
                pokemon_id: pokemon.pokemon_id,
                pokemon_name: pokemon.pokemon_name,
                twitch_username: pokemon.twitch_username || "",  // Fallback falls nicht vorhanden
                gefangen: typeof pokemon.gefangen === 'boolean' ? pokemon.gefangen : 
                          (pokemon.gefangen === 'true' || pokemon.gefangen === 't'),
                shiny: typeof pokemon.shiny === 'boolean' ? pokemon.shiny : 
                       (pokemon.shiny === 'true' || pokemon.shiny === 't')
            };
        });

        // Debug: Normalisierte Daten
        console.log("Normalisierte Daten:", JSON.stringify(data));

        // Finde speziell Dragoran mit ID 149 zum Debugging
        const dragoniteEntries = data.filter(p => p.pokemon_id === 149);
        console.log("Dragoran Einträge:", dragoniteEntries);

        // Normalisiere zuerst alle Nutzernamen auf die gleiche Schreibweise (lowercase)
        // und kombiniere doppelte Einträge vom gleichen Benutzer (unterschiedliche Schreibweise)
        const userPokemonMap = new Map();

        // Gruppiere Pokémon nach Benutzer (Case-insensitive) und Pokémon-ID
        data.forEach(pokemon => {
            // Nutze lowercase username und pokemon_id als Schlüssel
            const lowercaseUsername = pokemon.twitch_username ? pokemon.twitch_username.toLowerCase() : '';
            const key = `${lowercaseUsername}-${pokemon.pokemon_id}`;
            
            console.log(`Verarbeite Pokemon: ${pokemon.pokemon_name} (ID: ${pokemon.pokemon_id}) von ${pokemon.twitch_username}`);
            console.log(`  - gefangen: ${pokemon.gefangen}, shiny: ${pokemon.shiny}`);
            console.log(`  - key: ${key}`);
            
            if (userPokemonMap.has(key)) {
                const existingEntry = userPokemonMap.get(key);
                console.log(`  - Existierender Eintrag gefunden für ${key}`);
                console.log(`  - Existierender Eintrag: gefangen=${existingEntry.gefangen}, shiny=${existingEntry.shiny}`);
                
                // Wenn es ein neuer Eintrag mit shiny=true ist, aktualisiere den bestehenden Eintrag
                if (pokemon.shiny && !existingEntry.shiny) {
                    console.log(`  - Update: shiny von ${existingEntry.shiny} zu ${pokemon.shiny}`);
                    existingEntry.shiny = true;
                }
                
                // Wenn es ein neuer Eintrag mit gefangen=true ist, aktualisiere den bestehenden Eintrag
                if (pokemon.gefangen && !existingEntry.gefangen) {
                    console.log(`  - Update: gefangen von ${existingEntry.gefangen} zu ${pokemon.gefangen}`);
                    existingEntry.gefangen = true;
                }
            } else {
                // Neuer Eintrag - kopiere das Pokémon-Objekt (um es nicht zu verändern)
                console.log(`  - Neuer Eintrag für ${key}`);
                userPokemonMap.set(key, { ...pokemon });
            }
        });

        // Debug: userPokemonMap Zwischenzustand
        console.log("Benutzer-Pokemon Map:", Array.from(userPokemonMap.entries()));

        // Speziell für Dragoran prüfen
        const dragoniteMapEntries = Array.from(userPokemonMap.entries())
            .filter(([key]) => key.includes('-149'));
        console.log("Dragoran in der Map:", dragoniteMapEntries);

        // Jetzt sammle alle eindeutigen Pokémon und bevorzuge Shinys
        const seenPokemon = new Map();

        // Verarbeite die zusammengeführten Benutzer-Pokémon
        userPokemonMap.forEach((pokemon, key) => {
            const pokemonKey = pokemon.pokemon_id.toString();
            
            console.log(`Verarbeite kombiniertes Pokemon: ${pokemon.pokemon_name} (ID: ${pokemon.pokemon_id})`);
            console.log(`  - gefangen: ${pokemon.gefangen}, shiny: ${pokemon.shiny}`);
            
            // Wenn dieses Pokémon bereits gesehen wurde
            if (seenPokemon.has(pokemonKey)) {
                const existingPokemon = seenPokemon.get(pokemonKey);
                console.log(`  - Existierender Eintrag in seen Map: ${existingPokemon.pokemon_name}`);
                console.log(`  - Existing: gefangen=${existingPokemon.gefangen}, shiny=${existingPokemon.shiny}`);
                
                // Priorisiere: 1. Shiny gefangen, 2. Normal gefangen, 3. Shiny gesehen, 4. Normal gesehen
                const currentPriority = (pokemon.shiny ? 2 : 0) + (pokemon.gefangen ? 1 : 0);
                const existingPriority = (existingPokemon.shiny ? 2 : 0) + (existingPokemon.gefangen ? 1 : 0);
                
                console.log(`  - Priorität: Aktuell=${currentPriority}, Existierend=${existingPriority}`);
                
                if (currentPriority > existingPriority) {
                    console.log(`  - Ersetze mit höherer Priorität!`);
                    seenPokemon.set(pokemonKey, pokemon);
                }
            } else {
                // Neues Pokémon hinzufügen
                console.log(`  - Neuer Eintrag in seen Map`);
                seenPokemon.set(pokemonKey, pokemon);
            }
        });

        // Debug: Finale Map
        console.log("Finale Pokemon Map:", Array.from(seenPokemon.entries()));

        // Speziell für Dragoran prüfen
        const finalDragonite = seenPokemon.get('149');
        console.log("Finaler Dragoran Eintrag:", finalDragonite);

        // Konvertiere die Map-Werte zurück in ein Array
        const uniqueData = Array.from(seenPokemon.values());
        
        // Nach ID sortieren
        const sortedData = uniqueData.sort((a, b) => a.pokemon_id - b.pokemon_id);

        // Aktualisiere den Shiny-Counter
        updateShinyCounter(sortedData);

        // Zähler für gefangene und gesehene Pokémon
        let caughtCount = 0;
        let seenCount = 0;

        // Erstelle die Pokémon-Karten
        sortedData.forEach(pokemon => {
            // Debug für Dragoran
            if (pokemon.pokemon_id === 149) {
                console.log("Dragoran beim Rendern:", pokemon);
                console.log("Shiny-Status:", pokemon.shiny);
            }
            
            // Formatierung der Pokémon-ID für den Bildpfad
            const paddedId = pokemon.pokemon_id.toString().padStart(3, '0');
            const imageUrl = `https://raw.githubusercontent.com/Skylldra/PokemonCatch/main/Pokedex/${paddedId}.png`;

            // Shiny-Indikator
            const shinyIndicator = pokemon.shiny ? '<span class="shiny-indicator">✨</span>' : '';
            
            // Debug für Shiny-Indikator bei Dragoran
            if (pokemon.pokemon_id === 149) {
                console.log("Dragoran Shiny-Indikator:", shinyIndicator);
            }

            // HTML für die Pokémon-Karte erstellen
            const pokemonCard = document.createElement('div');
            pokemonCard.className = 'pokemon-card';
            pokemonCard.onclick = function() {
                openModal(pokemon.pokemon_id, pokemon.pokemon_name, imageUrl);
            };

            pokemonCard.innerHTML = `
                <img src="${imageUrl}" alt="${pokemon.pokemon_name}" class="pokemon-image">
                <div class="pokemon-name">${pokemon.pokemon_name} ${shinyIndicator}</div>
                <div class="pokemon-id">#${pokemon.pokemon_id}</div>
            `;

            // Je nach Status zur entsprechenden Liste hinzufügen
            if (pokemon.gefangen) {
                caughtGrid.appendChild(pokemonCard);
                caughtCount++;
            } else {
                seenGrid.appendChild(pokemonCard);
                seenCount++;
            }
        });

        // Wenn eine Liste leer ist, entsprechende Nachricht anzeigen
        if (caughtCount === 0) {
            caughtGrid.innerHTML = "<div class='empty-message'>Keine gefangenen Pokémon!</div>";
        }
        if (seenCount === 0) {
            seenGrid.innerHTML = "<div class='empty-message'>Keine gesehenen Pokémon!</div>";
        }

        // Aktualisiere die Spaltenüberschriften mit der Anzahl
        document.querySelector("#caught-pokemon .section-title").innerText = 
            `Gefangene Pokémon (${caughtCount})`;
        document.querySelector("#seen-pokemon .section-title").innerText = 
            `Gesehene Pokémon (${seenCount})`;
    })
    .catch(error => {
        document.getElementById("caught-grid").innerHTML = "<div class='empty-message'>Fehler beim Laden der Daten!</div>";
        document.getElementById("seen-grid").innerHTML = "<div class='empty-message'>Fehler beim Laden der Daten!</div>";
        console.error("Fehler beim Laden der Pokédex-Daten:", error);
    });
    </script>
</body>
</html>
